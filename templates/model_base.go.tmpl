package {{.modelPackageName}}

import "fmt"

// Action CRUD actions
type Action int32

var (
    // Create action when record is created
    Create = Action(0)

    // RetrieveOne action when a record is retrieved from db
    RetrieveOne = Action(1)

    // RetrieveMany action when record(s) are retrieved from db
    RetrieveMany = Action(2)

    // Update action when record is updated in db
    Update = Action(3)

    // Delete action when record is deleted in db
    Delete = Action(4)

    // FetchDDL action when fetching ddl info from db
    FetchDDL = Action(5)

    tables map[string]*TableInfo
)


func init()  {
    tables = make(map[string]*TableInfo)
    {{ range $tableName, $tableInfo := .tableInfos }}
    tables["{{$tableName}}"] = {{$tableName}}TableInfo
    {{- end}}
}

// String describe the action
func (i Action) String() string {
    switch i {
    case Create:
        return "Create"
    case RetrieveOne:
        return "RetrieveOne"
    case RetrieveMany:
        return "RetrieveMany"
    case Update:
        return "Update"
    case Delete:
        return "Delete"
    case FetchDDL:
        return "FetchDDL"
    default:
        return fmt.Sprintf("unknown action: %d", int(i))
    }
}

// Model interface methods for database structs generated
type Model interface {
    TableName() string
    BeforeSave() error
    Prepare()
    Validate(action Action) error
    TableInfo() *TableInfo
}

// TableInfo describes a table in the database
type TableInfo struct {
	Name    string        {{ .Config.JSONTag "name" }}
	Columns []*ColumnInfo {{ .Config.JSONTag "columns" }}
}

// ColumnInfo describes a column in the database table
type ColumnInfo struct {
	Index              int    {{ .Config.JSONTag "index" }}
	GoFieldName        string {{ .Config.JSONTag "go_field_name" }}
	GoFieldType        string {{ .Config.JSONTag "go_field_type" }}
	JSONFieldName      string {{ .Config.JSONTag "json_field_name" }}
	ProtobufFieldName  string {{ .Config.JSONTag "protobuf_field_name" }}
	ProtobufType       string {{ .Config.JSONTag "protobuf_field_type" }}
	ProtobufPos        int    {{ .Config.JSONTag "protobuf_field_pos" }}
	Comment            string {{ .Config.JSONTag "comment" }}
	Notes              string {{ .Config.JSONTag "notes" }}
	Name               string {{ .Config.JSONTag "name" }}
	Nullable           bool   {{ .Config.JSONTag "is_nullable" }}
	DatabaseTypeName   string {{ .Config.JSONTag "database_type_name" }}
	DatabaseTypePretty string {{ .Config.JSONTag "database_type_pretty" }}
	IsPrimaryKey       bool   {{ .Config.JSONTag "is_primary_key" }}
	IsAutoIncrement    bool   {{ .Config.JSONTag "is_auto_increment" }}
	IsArray            bool   {{ .Config.JSONTag "is_array" }}
	ColumnType         string {{ .Config.JSONTag "column_type" }}
	ColumnLength       int64  {{ .Config.JSONTag "column_length" }}
	DefaultValue       string {{ .Config.JSONTag "default_value" }}
}

// GetTableInfo retrieve TableInfo for a table
func GetTableInfo(name string) (*TableInfo, bool) {
    val, ok :=  tables[name]
    return val, ok
}
